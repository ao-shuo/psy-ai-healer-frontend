# 心理AI疗愈平台实施步骤指南

## 1. 环境与依赖准备
- **后端**：使用 Java 21 + Spring Boot 3.x，依赖 Spring Security、WebSocket、JPA/MySQL、Redis。推荐直接运行 `./mvnw spring-boot:run` 并借助 `src/main/java/com/example/psyaihealer/config` 中的配置类做联调。
- **前端**：基于 Vue 3 + Vite 的应用，安装依赖 `npm ci`，用 `npm run dev` 启动。前端统一请求封装在[psy-ai-healer-frontend/src/services/api.ts](psy-ai-healer-frontend/src/services/api.ts#L1-L58)，登录态维护在[psy-ai-healer-frontend/src/stores/auth.ts](psy-ai-healer-frontend/src/stores/auth.ts#L1-L130)，所有后端交互都通过这两者组合完成。
- **全局变量**：将后端基础地址写入 `.env` 里 `VITE_API_BASE_URL`，`resolveBase` 会自动规整斜杠；认证之后每次请求通过 `authFetch` 添加 `Authorization` 头。

## 2. 前端通用能力
- **请求与认证链路**：消费 API 时先用 `useAuthStore` 读取 `token` 并持久化（详见[stores/auth.ts](src/stores/auth.ts#L59-L130)），再通过 `authFetch` 发送携带 Token 的请求，相同 Cookie-less 架构可复用于未来的资源库、日志、AI 舱。
- **状态持久化**：`token`、`username`、`roles` 保存于 LocalStorage，`reset`/`persist` 方法统一读写，登录/注册调用 `apiFetch('/auth/login')`/`apiFetch('/auth/register')` 即可自动完成状态同步。
- **WebSocket 入口**：后端用了[psy-ai-healer/src/main/java/com/example/psyaihealer/config/WebSocketConfig.java](psy-ai-healer/src/main/java/com/example/psyaihealer/config/WebSocketConfig.java#L1-L32) 暴露 `/ws` 端点并启用 SockJS/STOMP。前端在 AI 舱组件里通过 `@stomp/stompjs` 连接该地址，可以在 `Live2D` 画面层监听 `/topic/ai/response` 并发送 `/app/ai/request`。

## 3. 学生用户模块
### 3.1 AI疗愈舱（文字/语音 + Live2D）
1. 在前端新增 `views/AiTherapyView.vue`，里面加载 Live2D 模型（可用 [Live2D SDK](https://docs.live2d.com/) 官方脚本）。
2. 打开 WebSocket 连接，前端定时/触发向后端 `/app/ai/message` 发送 { role: 'user', content, channel }，后端多智能体引擎需根据 channel 分发到共情/认知重构等能力单元。
3. 订阅 `/topic/ai/response`、`/topic/ai/summary`，将返回内容同步到 `Live2D` 表情、语音播放、对话列表以及历史记录中；所有对话条目同时写入用户的“成长日志”数据表。
4. 后端在 `multiagent` 包中设计 `AiConversationService`，调用外部 LLM 接口并结合 RAG 缩小上下文；对高风险关键词实时推送危机预警模块（见第 4.3）。
5. 语音输入可通过浏览器 `MediaRecorder` 和后端 `/api/ai/voice`，后端把音频转文本后再进入多智能体链路。

### 3.2 心理自评中心（PHQ-9 + 可视化）
1. 当前 UI 位于[psy-ai-healer-frontend/src/views/AssessmentView.vue](psy-ai-healer-frontend/src/views/AssessmentView.vue#L1-L66)，该页面已通过 `authFetch` 调用 `/assessments/phq9`，后台由[psy-ai-healer/src/main/java/com/example/psyaihealer/assessment/AssessmentController.java](psy-ai-healer/src/main/java/com/example/psyaihealer/assessment/AssessmentController.java#L1-L44) 提供分数与历史。
2. 在提交后根据 `result.score` 计算分级（例如 `0-4：正常，5-9：轻度`），在图表层用 `chart.js`/`apexcharts` 展示最近 6 次得分折线并标注严重度。
3. 结果区域可以补充建议（CBT 练习、情绪调节等），并为 `history` 数组添加标签字段，让用户点击某条记录时复现当天的主要描述。
4. 需要在后端 `AssessmentService` 内记录用户提交的 answers 及建议文本，未来可扩展到 `GAD-7`、`SAS` 等量表。

### 3.3 心灵资源库（文章、音频、视频）
1. 增设一个 `views/ResourcesView.vue` 和对应的 `stores/resource.ts`，在路由中暴露 `/resources` 页面。
2. 前端发送带分页的请求（如 `/api/resources?page=1&size=12`），后台可以在 `knowledge` 包新建 `Resource`, `ResourceRepository`，并提供全文检索字段（MySQL `FULLTEXT` 或 ElasticStack）。
3. 用户可以点开卡片后播放音频/视频，点击收藏后调用 `/api/resources/{id}/favorite` 并保存当前 `userId`。
4. 向前端导出标签、作者、难度等维度，便于筛选；同时为每条资源生成摘要并做版本控制，便于辅导员审核。

### 3.4 成长日志（私人 Mood + 历史曲线）
1. 创建 `views/JournalView.vue`，允许学生写下当日情绪（score + note），数据通过 `/api/journal` 保存，后端存储 `MoodEntry`（用户、score, note, tags）。
2. 结果在前端以时间轴和情绪曲线形式展示，与 `AssessmentView` 结果合并，形成情绪波动图；可使用 `chart.js` 将 mood score 标成缓冲区。
3. 添加历史对话卡片区域，结合 AI 舱的 `conversationId`，让用户回顾关键对话和对方给出的建议。
4. 增加“秘密”模式（仅前端展示，不发通知），默认所有条目用 JWT `sub` 作用域控制访问权限。

## 4. 心理咨询师功能
### 4.1 案例辅助面板
- 后端新增 `/api/therapist/cases`，接受授权的咨询师角色后可以拉取匿名的 `AiConversationSummary`（最新 3 条消息 + PHQ-9 severity + 心情趋势），这些数据基于 AI 舌尖强制脱敏处理。
- 前端通过新建 `views/TherapistPanelView.vue` 展示 `userId`、`severity`、`alertFlags`，点击模态框可跳转到 `growth log` 页签，帮助咨询师做准备。后台可继续调用 `multiagent` 的分析结果接口。

### 4.2 资源管理后台
- 建立 `/admin/resources` 管理页面，允许上传文章/音频并提交审核状态。前端需要表单校验和素材预览，后端 `knowledge` 包保存媒体 URL (OSS/Cloud Storage) 并标记 `status`。
- 资源发布后触发消息推送，通知对应的学生用户（可借助 WebSocket topic `/topic/notifications`）。

### 4.3 危机预警接口
- 后端在 AI 引擎 pipeline 中检测极端词汇（自杀、自残等），并通过 `/api/alerts` 发送 `Alert` 实体；同时推送 WebSocket `/topic/alerts` 给运营/咨询师。
- 前端心理咨询师控制台要有专版提示，高亮显示 `severity`、联系信息、最后一次对话内容，并提供“一键干预”按钮，调用 `/alerts/{id}/intervene` 记录人工处理流程。

## 5. 系统管理员模块
### 5.1 平台运维中心
- 管理员通过 `/api/admin/users`、`/api/admin/roles`，结合 JWT 角色判断权限；建议新增 `UserAdminController`，提供分页、搜索与角色更改接口。
- 前端面板列出用户列表、登录日志，配合 Redis 缓存的 session 信息可输出 `status`、`lastActive` 等。
- 保留数据备份脚本，可使用 Spring Boot `CommandLineRunner` 定期将关键表导出至压缩包上传云存储。

### 5.2 AI引擎配置
- 配置集中在 `aiconfig` 包，`AiEngineConfig`、`AiEngineConfigRepository` 控制数字人形象、语音和策略规则。管理员通过前端表单修改这份配置，并触发 `/api/aiconfig/reload` 实现热更新。
- 前端基于新建的 `views/AiEngineConfigView.vue` 展示可调参数（模型温度、token限制、感知风格）并允许保存到后端表中。

## 6. 数据与 AI 集成要点
- 所有核心数据（用户、对话、评估、资源、日志）均落在 MySQL，可在 `application.yml` 里设置 `ddl-auto=update` 并使用 `@Schema` 精确定义索引。
- Redis 作为缓存层时机：认证 Token 黑名单、资源列表缓存、AI 相似度缓存。可通过 `@Cacheable` 注解包裹 `AssessmentService` 和 `ResourceService`。
- AI 多智能体引擎在 `multiagent` 包中实现多阶段处理，第一阶段理解、第二阶段 CBT 建议、第三阶段生成 `Alert`；RAG 用知识库 `knowledge` 里的条目进行召回。

## 7. 发布与验证
1. 运行 `mvnw clean package` 和 `npm run build`，后端生成 JAR 放在 `target/` 里，前端产出 `dist/`，可合并成单个部署包。
2. 编写集成测试：后端使用 `@SpringBootTest` + MockMvc 验证 `/api/assessments/phq9`、`/api/alerts` 等；前端用 Vitest 测试关键组件、用 Playwright 检查 Live2D → WebSocket 通信。
3. 上线前做安全扫描：前端静态资源加 CDN，后端开启 Spring Security `SecurityConfig` 黑名单，确保 JWT 过期处理、CORS 白名单。
4. 监控与运维：结合 `actuator`、定期快照 MySQL、Redis 配置 `maxmemory-policy`，并通过 WebSocket 报警渠道接收高风险用户事件。
